package com.vn.trn.app.framework.container.interceptor;

import javax.servlet.http.HttpServletRequest;

import org.aopalliance.intercept.MethodInvocation;

import com.vn.trn.app.framework.container.RequestContext;
import com.vn.trn.app.framework.container.impl.RequestContextImpl;

/**
 * RequestContext????????????????????????
 */
public class RequestContextInterceptor extends BaseInterceptor {

	/** serialVersionUID */
	private static final long serialVersionUID = 671587319542069545L;

	/** requestContext */
	private RequestContext requestContext = null;

	/**
	 * ?????????????????????
	 * requestContext??????
	 */
	public RequestContextInterceptor() {
		super();
		// Request, Response??????
// 2013/08/08 m.mochizuki start
//		S2Container container = SingletonS2ContainerFactory.getContainer();
//		requestContext = (RequestContext) container.getComponent(RequestContext.class);
		requestContext = new RequestContextImpl();
		requestContext.setRequest(request);
		requestContext.setResponse(response);
// 2013/08/08 m.mochizuki end
	}

	/**
	 * ????????????????????????
	 * @param invocation MethodInvocation
	 * @return Object ?????????
	 * @throws Throwable ????????????
	 */
	public Object invoke(MethodInvocation invocation) throws Throwable {
		HttpServletRequest request = requestContext.getRequest();
		String servletPath = request.getServletPath();
		// ?????????????????????????????????
		String servletName = servletPath;
		servletName = servletName.replaceFirst("^.*/", "");
		servletName = servletName.replaceFirst("\\..*$", "");
		// ???????????????????????????????????????????????????????????????????????????????????????
		if (request.getAttribute("SERVLET_PATH") == null) {
			request.setAttribute("SERVLET_PATH", servletPath);
		}
		request.setAttribute("SERVLET_NAME", servletName);
		requestContext.setServletName(servletName);
		Object ret;
		try {
			// Action??????
			ret = invocation.proceed();
		} finally {
			requestContext.setServletName(null);
		}
		return ret;
	}
}